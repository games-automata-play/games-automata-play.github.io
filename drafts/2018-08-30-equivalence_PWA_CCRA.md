---
layout:     post
title:      Equivalence betwen P-WA and CCRA
date:       2018-08-28 10:00:00
author:     Nathana&euml;l Fijalkow and Corentin Barloy
category:   Weighted automata
---

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: {
    Macros: {
      N: "{\\mathbb{N}}",
      M: "{\\mathcal{M}}",
      Q: "{\\mathbb{Q}}",
      Ninfty: "{\\mathbb{N}_{\\infty}}",
      A: "{\\mathcal{A}}",
    }
  }
});
</script>

<p class="intro"><span class="dropcap">W</span>eighted automata (WA) and cost register automata (CRA) are two different models of automata. Over the one letter alphabet, those two functions computes sequences with values in a given semiring (here $\Q$). We are going to show that two restrictions of those models computes the same sequences: polynomialy ambiguous WA and copyless CRA. </p>

### Weighted automata

Intuitively, WA are automata where a weight in $\Q$ is associated to each transition. Formally, it is a tuple:

$$ \A = (Q, \alpha : Q \rightarrow \Q, \delta: Q\times Q\rightarrow\Q, \eta: Q \rightarrow \Q ) $$

$\alpha$ is the initial function, $\delta$ is the transition function (remember that we work with a unary alphabet) and $\eta$ is the output function.

Given a run in $\A$, the weight of the run is the product of the initial weight, the final weight and every weight along the path. The sequence computed by $\A$ is such that the value of index $n$ is the sum of the weight of every run for $a^n$.

The ambiguity of $\A$ is the sequence that associates to $n$ the number of accepting runs for $a^n$. An automaton is said to be polynomialy ambiguous if his ambiguity grows at most polynomialy. The set of sequences computed by a polynomialy ambiguous automaton is denoted by P-WA.

### Cost register automata

CRA are deterministic automata with write-only registers. For each transition, registers are updated. Formally, $Expr(X)$ is the set generated by the grammar $E := x\in X \| r\in \Q \| E+E \| E\times E$. Then a CRA is a tuple:

$$ \A = (Q, X, q_0, \nu: X\rightarrow \Q, \delta: Q \rightarrow Q\times (X\rightarrow Expr(X)), \mu: Q \rightarrow Expr(X)) $$ 

$q_0$ is the initial state. $\nu$ is the initial valuation, that is to say it initialize every registers. $\delta$ is the transition function, it associates to a state the next state and how every registers are upated depending on the other registers. $\mu$ is the output function, when the computation is done it shows how to calculate the value of the run with the registers.

A CRA is said to be copyless if in an update use each register at least once. The class of sequences computed by copyless automata is CCRA.

### A characterization for CCRA

We will give here a convenient characterization for CCRA. 

#### Operators 

For a better statement of the theorem, we will use some operators over sets of sequences. If $P$ is a set of sequences then

* $SHIFT(P)$ is the set of sequences that belongs to $P$ up to a certain index.
* $SUM(P)$ is the set of sequences that are finite sum of sequences in $P$.
* $PROD(P)$ is the set of sequences that are finite product of sequences in $P$.
* $INTER(P)$ is the set of sequences $u$ such that there exists $N\in\N$ such that for every $0\leq i < N$ then $(u_{Nn+i})_n$ belongs to $P$. 
* $AG$ is the set of arithmetic-geometric sequences.

We will prove the following theorem:

> **Theorem:**
CCRA = $ SHIFT \circ INTER \circ SUM \circ PROD(AG) $

#### Direct inclusion

The shape of a deterministic automaton over a one letter alphabet is well known: it is a linear structure with maybe a loop over the last state. 

We only have to consider automata with only the loop. Indeed, the linear structure before the loop correspond to the $SHIFT$ part. Moreover, if we fix some state $q$, we can consider the one-state automaton with:

* As initial valuation: the value for each register found by going from the initial state to $q$.
* As transition function: the update found when we do one loop from $q$ to $q$.
* As output expression: the output expression associated to $q$.

We only need to show that this automaton computes a sequence in $INTER \circ SUM \circ PROD(AG)$, because what we want is an interleaving of those automaton (and $INTER \circ INTER = INTER) $. We can note that this automaton is copyless because doing several copyless updates preserves the copylessness.

For that purpose, we need to introduce the concept of stable register: a register is stable if his update implies himself (like $x = x+y $). Intuitively, if a register is not stable, it "loses" his value. Since we consider copylessness, if the update of some register $x$ uses some register $y$, then $y$ cannot be stable. It can be shown that if we iterate the update several time (bounded by the number of registers) then each register is either stable either updated with a constant. So registers updated with a constant are describes a constant progression, and the stable ones are updated only with themselves and not stable registers so it is equivalent to something of the form $x := ax+b $ with $a$ and $b$ two constants. So every register grows with an arithmetic-geometric progression and the output expression can be put under the form of a sum of product of registers.

#### Reverse inclusion 

To computes an arithmetic-geometric sequence of parameter $a$ and $b$ with a CCRA, we just have to construct the automaton with one register $x$ initialized with the first value of the sequence. The update is $x := ax +b$ and the output is only $x$.

For a sum of product of arithmetic-geometric sequences, we use a register for each sequence, updated like previously. Then we ouput the right combination of sum and product of those registers.

For a sequence in $INTER \circ SUM \circ PROD(AG)$ with $N$ sequences interleaved, we construct a single loop with $N$ states. Each state have his own set of registers updated like before. Finally, we just add some linear structure in front of the loop for the $SHIFT$ part.

### Study of P-WA

Now, let us focus on polynomialy ambiguous automata. We are going to decompose those automata into a sum of simpler automata: chained loops. A chained loop is the concatenation of deterministic automata with only one accepting state.

It is easy to see that two distinct loops in such automata cannot have a state in common. So, if we consider automata as graphs then each strongly connected component would be either a single state either a single loop. For each path in the SCC graph, we can build an automaton (that is a chained loop) with every states along the path. The union of those automata for each paths in the SCC graph is equivalent to the initial automaton.

> **Theorem:**
Let $\A$ be an automaton in P-WA. Then $\A$ is equivalent to a union of chained loops.

#### Introuction of series

To study such automata, series are very convenient. A serie is (here) a function from $\N$ to $\Q$. We represents them as a sum $\sum_n a_n X^n$, and we use two operations on them: addition and Cauchy product. The inverse of a serie $s$ (when it exists) is $1-s^*$ where 

$$ s^* = \sum_n s^n $$

It is easy to see that a deterministic automaton recognizes a series of the form $\frac{\alpha X^p}{1-\lambda X^N}$. $p$ and $\alpha$ are the size and weight of the linear structure before the loop. $N$ and $\lambda$ are the size and weight of the loop. Since concatenation and cauchy product are counterparts, then a chained loop recognizes a serie of the form: $\lambda X^N \prod_{i=1}^l \frac{1}{1-\lambda_i X^{N_i}}$. Finally: 

> **Theorem:**
An automaton in P-WA recognizes a serie of the form $\sum_i \lambda_i X^{N_i} \prod_j \frac{1}{1-\lambda_{i,j} X^{N_{i,j}}}$.

#### Fibonacci

We can calculate a simple expression of the Fibonacci serie (thanks to Binet formula): $\frac{X}{1-X-X^2}$. Thanks to that, we know that this series is not in P-WA. Indeed, otherwise $\varphi^{-1}$ (the inverse of the golden ratio) would be the root of some $1-\lambda_i X^{N_i}$, which is false because every iterate of $\varphi^{-1}$ are irrational.

> **Theorem:**
P-WA is a strict subclass of all WA

This is a first view of the power of series.

#### P-WA $\subseteq$ CCRA

Because CCRA is closed under sum and multiplication by a monomial, it is enought to prove that every $\prod_i \frac{1}{1-\lambda_{i} X^{N_{i}}}$ belongs to CCRA. With some calculatory trick, we can put such a series into a sum of $\frac{1}{(1-\lambda X)^k}$. But those series can be written $\sum_n \binom{n+k-1}{k} \lambda^n X^n$. But $\binom{n+k-1}{k}$ is polynomial in $n$, so it is enough to concude to see that every $n^k\lambda^n$ are in CCRA.

### CCRA $\subseteq$ P-WA

Thanks to the characterization of CCRA, and the fact that P-WA is stable under $SHIFT$, $INTER$ and $SUM$, we only have to show that $PROD(AG)\subseteq$ P-WA. 

When we have a linear recurrent system, we can easily associate a WA that recognize the sequence computed by this system: each state are a sequence of the system and the transition are the dependencies between the sequences. 

So if a linear recurrent system is triangular (if his matrix is) then every loop of the automaton associated are of size 1. So the automaton is in P-WA.

An arithmetic-geometric sequence can be computed by a triangular LRS. By induction, a product of arithmetic-geometric can be computed by a triangular LRS. Indeed, we can develop the product and have a sum of such product that are computed by a triangular LRS.

It is enough to conclude!





